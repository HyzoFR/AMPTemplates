[
    {
        "UpdateStageName": "App Download",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd hyzo-rust && rm -rf srv >/dev/null 2>&1; DownloadSource=\\\"{{DownloadSource}}\\\"; DownloadBranch=\\\"{{DownloadBranch}}\\\"; if [[ -n \\\"{{DownloadPassword}}\\\" ]]; then DownloadUrl=\\\"${DownloadSource/https:\\/\\//https:\\/\\/{{DownloadPassword}}@}\\\"; else DownloadUrl=\\\"$DownloadSource\\\"; fi; [ ! -d .git ] && { echo \\\"Installing the app\\\" && git clone \\\"$DownloadUrl\\\" srv >/dev/null && \\cp -r srv/. ./ >/dev/null 2>&1 && rm -rf srv >/dev/null 2>&1 && [ -z \\\"$DownloadBranch\\\" ] && DownloadBranch=$(git symbolic-ref refs/remotes/origin/HEAD | sed \\\"s|.*/||\\\"); git checkout $DownloadBranch --force >/dev/null && git pull >/dev/null && echo \\\"App installed\\\"; } || { echo \\\"Updating the app\\\" && git remote set-url origin \\\"$DownloadUrl\\\" >/dev/null && [ -z \\\"$DownloadBranch\\\" ] && DownloadBranch=$(git symbolic-ref refs/remotes/origin/HEAD | sed \\\"s|.*/||\\\"); git checkout $DownloadBranch --force >/dev/null && git pull >/dev/null && echo \\\"App updated\\\"; }\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "App Download",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"$ProgressPreference='SilentlyContinue'; cd hyzo-rust; Remove-Item srv -Recurse -Force -ErrorAction SilentlyContinue | Out-Null; $DownloadSource = \\\"{{DownloadSource}}\\\"; $DownloadBranch = \\\"{{DownloadBranch}}\\\"; if (![string]::IsNullOrEmpty(\\\"{{DownloadPassword}}\\\")) { $DownloadUrl = $DownloadSource -replace \\\"https://\\\", \\\"https://{{DownloadPassword}}@\\\" } else { $DownloadUrl = \\\"$DownloadSource\\\" }; if (-Not (Test-Path .git)) { Write-Output \\\"Installing the app\\\"; git clone \\\"$DownloadUrl\\\" srv 1> $null; Copy-Item srv/* ./ -Recurse -Force -ErrorAction SilentlyContinue | Out-Null; Remove-Item srv -Recurse -Force -ErrorAction SilentlyContinue | Out-Null; if ([string]::IsNullOrEmpty($DownloadBranch)) { $DownloadBranch = (git symbolic-ref refs/remotes/origin/HEAD) -replace '.*/' }; git checkout --force $DownloadBranch 1> $null; if ($LASTEXITCODE -eq 0) { git pull 1> $null }; if ($LASTEXITCODE -eq 0) { Write-Output \\\"App installed\\\" } } else { Write-Output \\\"Updating the app\\\"; git remote set-url origin \\\"$DownloadUrl\\\" 1> $null; if ([string]::IsNullOrEmpty($DownloadBranch)) { $DownloadBranch = (git symbolic-ref refs/remotes/origin/HEAD) -replace '.*/' }; git checkout --force $DownloadBranch 1> $null; if ($LASTEXITCODE -eq 0) { git pull 1> $null }; if ($LASTEXITCODE -eq 0) { Write-Output \\\"App updated\\\" } }\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Install Rust",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"export RUSTUP_HOME=\\\"$PWD/.rustup\\\" CARGO_HOME=\\\"$PWD/.cargo\\\"; if [ -f .cargo/bin/rustup ]; then echo 'Updating Rust toolchain...' && .cargo/bin/rustup update stable && echo 'Rust updated'; else echo 'Installing Rust via rustup...' && curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path --default-toolchain stable && echo 'Rust installed'; fi\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Install Rust",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"$env:RUSTUP_HOME = \\\"$PWD\\.rustup\\\"; $env:CARGO_HOME = \\\"$PWD\\.cargo\\\"; if (Test-Path '.cargo\\bin\\rustup.exe') { Write-Output 'Updating Rust toolchain...'; & '.cargo\\bin\\rustup.exe' update stable; if ($LASTEXITCODE -eq 0) { Write-Output 'Rust updated' } else { exit 1 } } else { Write-Output 'Installing Rust via rustup...'; $ProgressPreference = 'SilentlyContinue'; Invoke-WebRequest -Uri 'https://win.rustup.rs/x86_64' -OutFile 'rustup-init.exe'; Start-Process -FilePath '.\\rustup-init.exe' -ArgumentList '-y', '--no-modify-path', '--default-toolchain', 'stable' -Wait -NoNewWindow; Remove-Item 'rustup-init.exe' -Force; if (Test-Path '.cargo\\bin\\rustup.exe') { Write-Output 'Rust installed' } else { Write-Output 'Rust installation failed'; exit 1 } }\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Write .env",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd hyzo-rust/{{AppDir}} && echo -e '{{EnvContent}}' > .env && echo '.env file written'\"",
        "UpdateSourceConditionSetting": "EnvContent",
        "UpdateSourceConditionValue": "!",
        "SkipOnFailure": true
    },
    {
        "UpdateStageName": "Write .env",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"Set-Location -Path 'hyzo-rust\\{{AppDir}}'; $content = '{{EnvContent}}' -replace '\\\\n', \\\"`n\\\"; Set-Content -Path '.env' -Value $content; Write-Output '.env file written'\"",
        "UpdateSourceConditionSetting": "EnvContent",
        "UpdateSourceConditionValue": "!",
        "SkipOnFailure": true
    },
    {
        "UpdateStageName": "Build App",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"export RUSTUP_HOME=\\\"$PWD/.rustup\\\" CARGO_HOME=\\\"$PWD/.cargo\\\" PATH=\\\"$PWD/.cargo/bin:$PATH\\\"; cd hyzo-rust && echo 'Building Rust application...' && cargo build {{ReleaseMode}} {{CargoFeatures}} {{CargoArgs}} && echo 'Build complete'\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Build App",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"$env:RUSTUP_HOME = \\\"$PWD\\.rustup\\\"; $env:CARGO_HOME = \\\"$PWD\\.cargo\\\"; $env:PATH = \\\"$PWD\\.cargo\\bin;$env:PATH\\\"; Set-Location -Path 'hyzo-rust'; Write-Output 'Building Rust application...'; cargo build {{ReleaseMode}} {{CargoFeatures}} {{CargoArgs}}; if ($LASTEXITCODE -eq 0) { Write-Output 'Build complete' } else { exit 1 }\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Run App",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"export RUSTUP_HOME=\\\"$PWD/.rustup\\\" CARGO_HOME=\\\"$PWD/.cargo\\\" PATH=\\\"$PWD/.cargo/bin:$PATH\\\"; cd hyzo-rust/{{AppDir}} && echo 'Starting Rust application...' && cargo run {{ReleaseMode}} {{CargoFeatures}} {{CargoArgs}} -- {{AppArgs}}\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Run App",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-NoProfile -Command \"$env:RUSTUP_HOME = \\\"$PWD\\.rustup\\\"; $env:CARGO_HOME = \\\"$PWD\\.cargo\\\"; $env:PATH = \\\"$PWD\\.cargo\\bin;$env:PATH\\\"; Set-Location -Path 'hyzo-rust\\{{AppDir}}'; Write-Output 'Starting Rust application...'; cargo run {{ReleaseMode}} {{CargoFeatures}} {{CargoArgs}} -- {{AppArgs}}\"",
        "SkipOnFailure": false
    }
]
